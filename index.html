<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .number-cell {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
            cursor: pointer;
        }
        
        .yellow-bg {
            background-color: yellow;
        }
        
        .green-bg {
            background-color: lightgreen;
        }
        
        .red-bg {
            background-color: red !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }
        
        .purple-bg {
            background-color: purple;
            color: white;
        }
        
        .car-icon {
            margin-left: 5px;
        }
        
        button {
            margin: 5px;
            padding: 10px;
        }

        .navigation-buttons {
            margin-top: 20px;
        }

        .grid-9 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 300px;
        }

        .grid-cell {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 50px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }

        .delete-btn, .noting-btn {
            background: red;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .delete-btn:hover, .noting-btn:hover {
            background: darkred;
        }

        .voice-mode-button, #voicePlayButton {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
        }

        .voice-mode-button:hover, #voicePlayButton:hover {
            background-color: #e0e0e0;
        }

        .selected-button {
            background-color: #ffcc00; /* é»ƒè‰²èƒŒæ™¯ */
            color: black;
            font-weight: bold;
        }
        
        .grid-controls {
            display: flex;
            justify-content: left;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .race-info {
            margin-top: 5px;
            font-size: 14px;
            color: gray;
        }
        
        .grid-summary {
            margin-top: 5px;
            font-size: 14px;
            font-weight: bold;
            color: gray;
        }
        
        /* Updated user instructions style */
        #userInstructions {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            border-top: 2px solid #ccc;
        }
        
        #userInstructions ul {
            padding-left: 20px;
        }

        /* Additional style for red warning text */
        #userInstructions ul[style*="color: red;"] {
            color: red;
        }
        
        /* Added styles for grid summary */
        
        /* æ–°å¢é›™æ ¼ä½”ç”¨çš„æ¨£å¼ */
        .occupied-double {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        /* ç¢ºä¿åˆªé™¤æŒ‰éˆ•èˆ‡ä¹å®®æ ¼ã€é¡å¤–æ ¼å­åˆ†é–‹ */
        .grid-container, .extra-cell {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            position: relative;
        }

        .grid-9, .extra-cell .grid-cell {
            min-height: 50px;
            border: 1px solid #ccc;
        }

        /* New styles for thank you section */
        #thankYouSection {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
            text-align: center;
        }

        #thankYouSection h2 {
            color: #f1c40f;
            font-size: 24px;
            margin-bottom: 15px;
        }

        #thankYouSection p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .highlight-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }

        .highlight-box h3 {
            color: #f39c12;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .highlight-box ul {
            text-align: left;
            padding-left: 20px;
        }

        .highlight-box ul li {
            list-style: none;
            font-size: 16px;
            padding: 5px 0;
        }

        .highlight-box ul li::before {
            content: "â­";
            margin-right: 5px;
            color: #f1c40f;
        }

        .intro {
            font-style: italic;
            color: #ecf0f1;
        }

        /* New styles for voice play button */
        #voicePlayButton {
            margin: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #voicePlayButton:hover {
            background-color: #e0e0e0;
        }
        
        /* Add new style for selected voice mode button */
        .voice-mode-button {
            margin: 5px;
            padding: 10px;
            transition: background-color 0.3s ease;
        }

        /* New styles for speech rate control */
        #speechRateControl {
            display: flex;
            align-items: center;
            margin: 10px 0;
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
        }

        #speechRateControl label {
            margin-right: 10px;
        }

        #speechRate {
            flex-grow: 1;
            margin: 0 10px;
        }

        #rateValue {
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        /* Add subtle styles for voice control buttons */
        #voicePlayButton, #voiceStopButton {
            font-size: 18px;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #voicePlayButton:hover, #voiceStopButton:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div id="page1" class="page active">
        <h2>ç¬¬1é ï¼šè«‹è¼¸å…¥å ´æ¬¡æ•¸é‡</h2>
        <input type="number" id="raceCount" min="1" max="10">
        <div class="navigation-buttons">
            <button onclick="goToPage(4)">ä¸Šä¸€é </button>
            <button onclick="goToPage2()">ä¸‹ä¸€é </button>
        </div>

        <!-- Updated Thank You Section with New Design -->
        <div id="thankYouSection">
            <h2>ğŸš€ Jadenç· é€ æ–°æ™‚ä»£ï¼ŒåŠ©åŠ›åœ˜éšŠé‚å‘é«˜å³°</h2>
            <p class="intro">
                åœ¨é€™å€‹è¬›æ±‚æ•ˆç‡èˆ‡æº–ç¢ºæ€§çš„æ™‚ä»£ï¼Œè³‡è¨Šç®¡ç†èˆ‡å·¥ä½œæµç¨‹çš„é †æš¢ï¼Œå°æ–¼åœ˜éšŠè€Œè¨€è‡³é—œé‡è¦ã€‚ç„¶è€Œï¼Œå›é¦–éå»ï¼Œæˆ‘å€‘çš„å·¥ä½œæ–¹å¼å»ä¸€ç›´ä¾è³´æœ€å‚³çµ±çš„è¨˜éŒ„æ–¹å¼â€”â€”ä¸€å¼µç´™ã€ä¸€æ”¯ç­†ï¼Œå°‡é‡è¦çš„æ•¸æ“šèˆ‡è³‡è¨Šç°¡å–®è¨˜éŒ„ä¸‹ä¾†ã€‚
            </p>
            <p>
                æ™‚é–“ä¸€ä¹…ï¼Œç­†è·¡æ½¦è‰é›£ä»¥è¾¨è­˜ï¼Œç´™å¼µéºå¤±æˆç‚ºå®¶å¸¸ä¾¿é£¯ï¼Œæ•¸æ“šçµ±è¨ˆå›°é›£é‡é‡ï¼ŒéŒ¯æ¼ç™¾å‡ºï¼Œå½±éŸ¿äº†å·¥ä½œçš„æµæš¢åº¦ï¼Œè®“åœ˜éšŠåœ¨æ—¥å¾©ä¸€æ—¥çš„æ··äº‚ä¸­è‹¦è‹¦æ™æ‰ã€‚
            </p>

            <div class="highlight-box">
                <h3>ğŸ”¹ ä¸€å ´æ”¹è®Šçš„é–‹å§‹</h3>
                <p>
                    ç•¶å¤§å®¶é‚„åœ¨ç¿’æ…£æ–¼é€™ç¨®æ¨¡å¼ï¼Œç”šè‡³èªç‚ºã€Œé€™å°±æ˜¯æ—¥å¸¸ã€æ™‚ï¼ŒJadenç«™äº†å‡ºä¾†ã€‚ä»–æ²’æœ‰æŠ±æ€¨ï¼Œä¹Ÿæ²’æœ‰é¸æ“‡æ¥å—ï¼Œè€Œæ˜¯ç”¨è¡Œå‹•æ”¹è®Šç¾ç‹€ã€‚ä»–æ·±çŸ¥ï¼Œå–®é ç´™å¼µè¨˜éŒ„å·²ç¶“ç„¡æ³•æ‡‰å°ç¾ä»£åŒ–å·¥ä½œçš„éœ€æ±‚ï¼Œæ–¼æ˜¯ï¼Œä»–æ†‘è—‰å …å®šçš„æ±ºå¿ƒå’Œç„¡æ¯”çš„è€å¿ƒï¼Œç‚ºåœ˜éšŠæ‰“é€ äº†ä¸€å€‹å…¨æ–°çš„ç¶²ç«™ï¼Œè®“è³‡è¨Šèƒ½å¤ äº•ç„¶æœ‰åºåœ°è¢«è¨˜éŒ„ã€æ•´ç†ã€æŸ¥æ‰¾èˆ‡å…±äº«ã€‚
                </p>
            </div>

            <div class="highlight-box">
                <h3>ğŸŒŸ é€™å€‹ç¶²ç«™å¸¶ä¾†çš„é©æ–°</h3>
                <ul>
                    <li>ğŸ”¹ <strong>å¿«é€ŸæŸ¥æ‰¾ï¼š</strong> åªéœ€é»æ“Šå¹¾ä¸‹ï¼Œå³å¯è¼•é¬†ç²å–æº–ç¢ºè³‡è¨Š</li>
                    <li>ğŸ”¹ <strong>é¿å…éŒ¯èª¤ï¼š</strong> æ•¸æ“šä¸å†éºå¤±èˆ‡éŒ¯æ¼ï¼Œæé«˜ç²¾ç¢ºæ€§</li>
                    <li>ğŸ”¹ <strong>é«˜æ•ˆç®¡ç†ï¼š</strong> å–ä»£æ··äº‚çš„è¨˜éŒ„æ–¹å¼ï¼Œè®“è³‡è¨Šäº•ç„¶æœ‰åº</li>
                </ul>
            </div>

            <p>
                é€™ä¸€åˆ‡ä¸¦éè¼•è€Œæ˜“èˆ‰çš„äº‹ã€‚Jadenåœ¨é–‹ç™¼é€™å€‹ç¶²ç«™çš„éç¨‹ä¸­ï¼Œä¸æ–·èª¿æ•´èˆ‡æ”¹é€²ï¼Œåè¦†æ¸¬è©¦èˆ‡å„ªåŒ–ï¼Œç¢ºä¿å®ƒèƒ½å¤ çœŸæ­£ç¬¦åˆå¤§å®¶çš„éœ€æ±‚ã€‚ä»–è€å¿ƒè†è½åŒäº‹å€‘çš„æ„è¦‹ï¼Œç´°å¿ƒæ‰“ç£¨æ¯ä¸€å€‹åŠŸèƒ½ï¼Œè®“ç¶²ç«™ä¸åƒ…å¯¦ç”¨ï¼Œè€Œä¸”æ“ä½œç°¡å–®ï¼Œè®“æ‰€æœ‰äººéƒ½èƒ½è¼•é¬†ä¸Šæ‰‹ã€‚
            </p>

            <div class="highlight-box">
                <h3>ğŸ‰ æ„Ÿè¬ Jaden çš„ä»˜å‡ºï¼</h3>
                <p>
                    åœ¨æ­¤ï¼Œæˆ‘å€‘å‘Jadenç»ä¸Šæœ€èª æ‘¯çš„æ„Ÿè¬ï¼Œæ„Ÿè¬ä»–çš„ç„¡ç§ä»˜å‡ºï¼Œæ„Ÿè¬ä»–å¸¶ä¾†çš„é€™ä»½æ”¹è®Šï¼Œæ„Ÿè¬ä»–è®“æˆ‘å€‘çš„å·¥ä½œè®Šå¾—æ›´åŠ é †æš¢èˆ‡é«˜æ•ˆã€‚
                </p>
                <p>
                    <strong>é¡˜ä»–çš„æœªä¾†æ›´åŠ è¼ç…Œï¼Œä¹Ÿé¡˜æˆ‘å€‘çš„åœ˜éšŠåœ¨é€™å€‹å…¨æ–°çš„èµ·é»ä¸Šï¼Œæ”œæ‰‹é‚å‘æ›´é«˜çš„æˆå°±ï¼ğŸš€ğŸ”¥</strong>
                </p>
            </div>
        </div>
    </div>

    <div id="page2" class="page">
        <h2>ç¬¬2é ï¼šè«‹è¼¸å…¥æ¯å ´é¦¬åŒ¹æ•¸é‡</h2>
        <div id="horseInputs"></div>
        <div class="navigation-buttons">
            <button onclick="goToPage(1)">ä¸Šä¸€é </button>
            <button onclick="goToPage3()">ä¸‹ä¸€é </button>
        </div>
    </div>

    <div id="page3" class="page">
        <h2>ç¬¬3é ï¼šè¨­å®šé¦¬åŒ¹è¦æ±‚</h2>
        <div id="raceSettings"></div>
        <div>
            <button onclick="setYellow()">é›™æ ¼</button>
            <button onclick="setGreen()">è¥¿å²¸</button>
            <button onclick="addCar()">ç´°è»ŠğŸš—</button>
        </div>
        <div class="navigation-buttons">
            <button onclick="goToPage(2)">ä¸Šä¸€é </button>
            <button onclick="goToPage4()">ä¸‹ä¸€é </button>
        </div>
    </div>

    <div id="page4" class="page">
        <h2>ç¬¬4é ï¼šç¢ºèªè¨­å®š</h2>
        <div>
            <button onclick="addGrid9()">æ–°å¢ä¹å®®æ ¼</button>
            <button onclick="addExtraCell()">æ–°å¢æ ¼å­</button>
            <button onclick="setUrineTest()">é©—å°¿æ¨¡å¼ï¼šé—œé–‰</button>
        </div>
        <div id="gridsContainer"></div>
        <div id="extraCellsContainer"></div>
        <div id="confirmationSettings"></div>

        <!-- ç”¨æˆ¶èªªæ˜å€å¡Š -->
        <div id="userInstructions">
            <h3>ğŸ“Œ ç”¨æˆ¶èªªæ˜</h3>
            
            <p><strong>ğŸ”¹ é»æ“Šä¹å®®æ ¼å…§çš„æ ¼å­ï¼š</strong></p>
            <ul>
                <li><strong>é»æ“Š 2 æ¬¡</strong> â†’ èƒŒæ™¯è®Šç´…è‰²ï¼Œè©²æ ¼å­é–å®šï¼Œç„¡æ³•æ”¾å…¥æ•¸å­—ã€‚</li>
                <li><strong>é»æ“Š 3 æ¬¡</strong> â†’ æ¢å¾©åŸç‹€ï¼Œå…è¨±æ”¾å…¥æ•¸å­—ã€‚</li>
            </ul>

            <p><strong>ğŸ”¹ èªéŸ³æ“ä½œï¼š</strong></p>
            <ul>
                <li>ğŸ”Š èªéŸ³é–‹é—œï¼šæ§åˆ¶æ˜¯å¦è‡ªå‹•æ’­æ”¾èªéŸ³</li>
                <li>ğŸ”Š æ’­æ”¾èªéŸ³ï¼šæ‰‹å‹•æ’­æ”¾æœ€è¿‘çš„å ´æ¬¡è³‡è¨Š</li>
            </ul>

            <p><strong>ğŸ”¹ é™åˆ¶äº‹é …ï¼š</strong></p>
            <ul style="color: red;">
                <li>âŒ æ­¤é é¢ç„¡æ³•è¿”å›ä¸Šä¸€é æˆ–é¦–é ã€‚</li>
                <li>âŒ è‹¥éœ€é‡æ–°è¨­å®šï¼Œè«‹åˆ·æ–°ï¼ˆé‡æ–°æ•´ç†/F5ï¼‰è¿”å›é é¢ã€‚</li>
            </ul>
        </div>
        
        <div id="speechRateControl">
            <label for="speechRate">èªéŸ³é€Ÿåº¦ï¼š</label>
            <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeechRate(this.value)">
            <span id="rateValue">1x</span>
        </div>
    </div>

    <script>
        let currentMode = '';
        let races = [];
        let gridCounter = 0;
        let cellCounter = 0;
        let urineTestActive = false;
        let latestRaceInfo = "";
        let voiceMode = ""; 
        let isVoiceEnabled = true;
        let speechRate = 1; //é»˜èªé€Ÿåº¦
        let notingMode = false;
        let speechSynthesisUtterance = null;

        function goToPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNumber}`).classList.add('active');
        }

        function goToPage2() {
            const count = parseInt(document.getElementById('raceCount').value);
            if (count > 0 && count <= 10) {
                goToPage(2);
                
                const container = document.getElementById('horseInputs');
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    container.innerHTML += `
                        <div>
                            <label>ç¬¬${i + 1}å ´é¦¬åŒ¹æ•¸é‡ï¼š</label>
                            <input type="number" id="race${i}" min="1" max="14">
                        </div>
                    `;
                }
            }
        }

        function goToPage3() {
            const inputs = document.querySelectorAll('#horseInputs input');
            races = [];
            let valid = true;
            
            inputs.forEach((input, index) => {
                const count = parseInt(input.value);
                if (count > 0 && count <= 14) {
                    races.push(count);
                } else {
                    valid = false;
                }
            });

            if (valid) {
                goToPage(3);
                createRaceGrid();
            }
        }

        function createRaceGrid() {
            const container = document.getElementById('raceSettings');
            container.innerHTML = '';
            
            races.forEach((horseCount, raceIndex) => {
                const grid = document.createElement('div');
                grid.innerHTML = `<h3>ç¬¬${raceIndex + 1}å ´</h3>`;
                const numberGrid = document.createElement('div');
                numberGrid.className = 'number-grid';
                
                for (let i = 1; i <= horseCount; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'number-cell';
                    cell.dataset.race = raceIndex;
                    cell.dataset.number = i;
                    cell.textContent = i;
                    cell.onclick = () => handleCellClick(cell);
                    
                    numberGrid.appendChild(cell);
                }
                
                grid.appendChild(numberGrid);
                container.appendChild(grid);
            });
        }

        function handleCellClick(cell) {
            if (!cell) return;

            if (urineTestActive) {
                if (cell.classList.contains('purple-bg')) {
                    const prevBg = cell.getAttribute('data-prev-bg') || "";
                    cell.classList.remove('purple-bg');
                    cell.classList.remove('yellow-bg', 'green-bg', 'red-bg'); 
                    if (prevBg) {
                        cell.classList.add(prevBg); 
                    }
                } else {
                    const bgClasses = ['yellow-bg', 'green-bg', 'red-bg'];
                    let originalBg = bgClasses.find(cls => cell.classList.contains(cls)) || "";
                    cell.setAttribute('data-prev-bg', originalBg);

                    cell.classList.remove('yellow-bg', 'green-bg', 'red-bg');
                    cell.classList.add('purple-bg');
                }
                return; 
            }

            cell.classList.remove('yellow-bg', 'green-bg', 'red-bg', 'purple-bg');
            const carIcon = cell.querySelector('.car-icon');
            if (carIcon) {
                carIcon.remove();
            }

            switch (currentMode) {
                case 'yellow':
                    cell.classList.add('yellow-bg');
                    break;
                case 'green':
                    cell.classList.add('green-bg');
                    break;
                case 'car':
                    if (!cell.querySelector('.car-icon')) {
                        cell.innerHTML += '<span class="car-icon">ğŸš—</span>';
                    }
                    break;
            }

            cell.dataset.mode = currentMode;

            document.querySelectorAll('.number-cell').forEach(c => c.classList.remove('selected'));

            cell.classList.add('selected');
        }

        function findAvailableGridCell() {
            const allGridCells = document.querySelectorAll('.grid-cell');
            
            let targetCell = Array.from(allGridCells).find(cell => 
                !cell.hasChildNodes() && !cell.classList.contains('occupied-double')
            );

            if (!targetCell) {
                targetCell = Array.from(document.querySelectorAll('.extra-cell .grid-cell'))
                    .find(cell => !cell.hasChildNodes());
            }

            return targetCell;
        }

        function moveToGrid(sourceCell, targetCell) {
            if (!sourceCell || !targetCell) {
                console.error('moveToGrid: Source or target cell is null');
                return;
            }
            
            if (targetCell.hasChildNodes() || targetCell.classList.contains('red-bg')) {
                console.warn('Target cell is already occupied or blocked');
                return;
            }

            const isDouble = sourceCell.classList.contains('yellow-bg');
            const isExtraCell = targetCell.closest('.extra-cell') !== null;
            const gridContainer = targetCell.closest('.grid-container') || targetCell.closest('.extra-cell');

            if (!gridContainer) {
                console.error('moveToGrid: No grid or extra cell container found');
                return;
            }

            const allGridCells = Array.from(gridContainer.querySelectorAll('.grid-cell'));
            const targetIndex = allGridCells.indexOf(targetCell);
            
            if (!isExtraCell && isDouble && (targetIndex % 3 === 2 || allGridCells[targetIndex + 1]?.hasChildNodes())) {
                alert("é›™æ ¼æ•¸å­—éœ€è¦ 2 å€‹ç›¸é„°çš„ç©ºæ ¼ï¼");
                return;
            }

            const newCell = sourceCell.cloneNode(true);
            newCell.dataset.originalRace = sourceCell.dataset.race;
            newCell.dataset.originalNumber = sourceCell.dataset.number;
            newCell.onclick = () => returnToTable(newCell.parentElement);

            if (sourceCell.classList.contains('yellow-bg')) newCell.classList.add('yellow-bg');
            if (sourceCell.classList.contains('green-bg')) newCell.classList.add('green-bg');
            if (sourceCell.querySelector('.car-icon')) {
                newCell.innerHTML += '<span class="car-icon">ğŸš—</span>';
            }

            newCell.innerHTML = `
                ${sourceCell.dataset.number}
                <div style="font-size: 12px; color: gray;">ç¬¬${parseInt(sourceCell.dataset.race) + 1}å ´</div>
            `;

            targetCell.appendChild(newCell);
            sourceCell.style.visibility = 'hidden';

            if (!isExtraCell && isDouble) {
                const nextCell = allGridCells[targetIndex + 1];
                if (nextCell) {
                    nextCell.classList.add('occupied-double');
                }
            }

            updateRaceInfo(targetCell);
        }

        function handleGridClick(cell) {
            if (cell.classList.contains('red-bg')) {
                return;
            }

            const selectedCell = document.querySelector('.number-cell.selected');
            if (selectedCell) {
                moveToGrid(selectedCell, cell);
                selectedCell.classList.remove('selected');
            }
        }

        function deleteGrid(gridId) {
            const grid = document.getElementById(gridId);
            if (grid) {
                returnAllToTable(grid);
                grid.remove();
            }
        }

        function deleteExtraCell(cellId) {
            const cell = document.getElementById(cellId);
            if (cell) {
                returnAllToTable(cell);
                cell.remove();
            }
        }

        function returnAllToTable(container) {
            const gridCells = container.querySelectorAll('.grid-cell');
            gridCells.forEach(cell => {
                if (cell.hasChildNodes()) {
                    returnToTable(cell);
                }
            });
        }

        function setYellow() {
            currentMode = 'yellow';
        }

        function setGreen() {
            currentMode = 'green';
        }

        function addCar() {
            currentMode = 'car';
        }

        function setRed() {
            currentMode = 'red';
        }

        function setUrineTest() {
            urineTestActive = !urineTestActive;
            currentMode = urineTestActive ? 'urine' : '';

            const button = document.querySelector('button[onclick="setUrineTest()"]');
            button.style.backgroundColor = urineTestActive ? 'purple' : '';
            button.style.color = urineTestActive ? 'white' : '';
            button.textContent = urineTestActive ? 'é©—å°¿æ¨¡å¼ï¼šé–‹å•Ÿ' : 'é©—å°¿æ¨¡å¼ï¼šé—œé–‰';

            // æ›´æ–°æ‰€æœ‰æ ¼å­çš„é»æ“Šè¡Œç‚º
            document.querySelectorAll('.number-cell').forEach(cell => {
                // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶
                cell.onclick = () => {
                    if (urineTestActive) {
                        handleCellClick(cell);
                    } else {
                        const targetGrid = findAvailableGridCell();
                        if (targetGrid) {
                            moveToGrid(cell, targetGrid);
                        }
                    }
                };
            });
        }

        function updateRaceInfo(targetCell) {
            if (!targetCell) {
                console.error('updateRaceInfo: Target cell is null');
                return;
            }

            const gridContainer = targetCell.closest('.grid-container');
            if (!gridContainer) {
                console.error('updateRaceInfo: No grid container found');
                return;
            }

            const raceInfoDiv = gridContainer.querySelector('.race-info');
            const summaryDiv = gridContainer.querySelector('.grid-summary');

            if (!raceInfoDiv || !summaryDiv) {
                console.error('Race info or summary divs not found');
                return;
            }

            let raceMap = new Map();
            let eastCount = 0;
            let westCount = 0;
            let totalCount = 0;

            gridContainer.querySelectorAll('.grid-cell .number-cell').forEach(cell => {
                let race = parseInt(cell.dataset.originalRace);
                let number = parseInt(cell.dataset.originalNumber);

                if (cell.classList.contains('green-bg')) {
                    westCount++;
                } else {
                    eastCount++;
                }
                totalCount++;

                if (!raceMap.has(race)) {
                    raceMap.set(race, []);
                }
                raceMap.get(race).push(number);
            });

            let sortedRaceEntries = Array.from(raceMap.entries()).sort((a, b) => a[0] - b[0]);
            sortedRaceEntries.forEach(entry => entry[1].sort((a, b) => a - b));

            let displayText = sortedRaceEntries.length > 0
                ? sortedRaceEntries.map(entry => `${entry[0] + 1}å ´: ${entry[1].map(num => `${num}è™Ÿ`).join(', ')}`).join(' | ')
                : 'å ´æ¬¡ï¼šç„¡';

            raceInfoDiv.textContent = displayText;
            summaryDiv.textContent = `æ±å²¸ç¸½æ•¸ï¼š${eastCount} | è¥¿å²¸ç¸½æ•¸ï¼š${westCount} | ç¸½æ•¸ï¼š${totalCount}`;

            latestRaceInfo = displayText;
        }

        function returnToTable(gridCell) {
            if (gridCell.hasChildNodes()) {
                const numberCell = gridCell.querySelector('.number-cell');
                const originalRace = numberCell.dataset.originalRace;
                const originalNumber = numberCell.dataset.originalNumber;
                const isDouble = numberCell.classList.contains('yellow-bg');

                if (!originalRace || !originalNumber) {
                    console.error('åŸå§‹æ•¸æ“šéºå¤±');
                    return;
                }

                const originalCell = document.querySelector(
                    `#confirmationSettings .number-cell[data-race="${originalRace}"][data-number="${originalNumber}"]`
                );

                if (originalCell) {
                    originalCell.style.visibility = 'visible';
                } else {
                    console.error('æ‰¾ä¸åˆ°åŸå§‹æ•¸å­—');
                }

                gridCell.innerHTML = '';

                if (isDouble) {
                    const gridContainer = gridCell.closest('.grid-container');
                    const allGridCells = Array.from(gridContainer.querySelectorAll('.grid-cell'));
                    const targetIndex = allGridCells.indexOf(gridCell);
                    if (targetIndex % 3 !== 2) {
                        allGridCells[targetIndex + 1].classList.remove('occupied-double');
                    }
                }

                updateRaceInfo(gridCell);
            }
        }

        function playRaceInfo() {
            if (latestRaceInfo && isVoiceEnabled) {
                let textToSpeak = latestRaceInfo.replace(/\|/g, 'ï¼Œ') + 
                    (voiceMode ? `ï¼Œ${voiceMode}` : '');

                speechSynthesisUtterance = new SpeechSynthesisUtterance(textToSpeak);
                speechSynthesisUtterance.lang = 'zh-HK'; 
                speechSynthesisUtterance.rate = speechRate;  
                speechSynthesisUtterance.pitch = 1; 

                window.speechSynthesis.cancel(); // ç¢ºä¿ä¹‹å‰çš„èªéŸ³è¢«åœæ­¢
                window.speechSynthesis.speak(speechSynthesisUtterance);
            } else {
                alert("æ²’æœ‰å¯æœ—è®€çš„å…§å®¹ï¼");
            }
        }

        function stopRaceInfo() {
            if (speechSynthesisUtterance) {
                window.speechSynthesis.cancel(); // åœæ­¢ç›®å‰æ’­æ”¾çš„èªéŸ³
            }
        }

        function addGrid9() {
            const container = document.getElementById('gridsContainer');
            const gridId = `grid-${gridCounter++}`;

            const gridHtml = `
                <div class="grid-container" id="${gridId}">
                    <div class="grid-controls">
                        <button class="delete-btn" onclick="deleteGrid('${gridId}')">ğŸ—‘ï¸ åˆªé™¤ä¹å®®æ ¼</button>
                        <button class="voice-mode-button" data-mode="è«‹æ‰“è…³åŒ…" onclick="setVoiceMode('è«‹æ‰“è…³åŒ…')">è«‹æ‰“è…³åŒ…</button>
                        <button class="voice-mode-button" data-mode="è«‹ä¸Šè»Š" onclick="setVoiceMode('è«‹ä¸Šè»Š')">è«‹ä¸Šè»Š</button>
                        <button id="voicePlayButton-${gridId}" onclick="playRaceInfo()">â–¶ï¸</button>
                        <button id="voiceStopButton-${gridId}" onclick="stopRaceInfo()">â¹ï¸</button>
                        <button class="noting-btn" onclick="toggleNotingMode()">noting</button>
                    </div>
                    <div class="grid-9">
                        ${Array(9).fill('').map(() => `<div class="grid-cell" onclick="applyNoting(this)"></div>`).join('')}
                    </div>
                    <div class="race-info" id="race-info-${gridId}" style="margin-top: 5px; font-size: 14px; color: gray;">
                        å ´æ¬¡ï¼šç„¡
                    </div>
                    <div class="grid-summary" id="grid-summary-${gridId}" style="margin-top: 5px; font-size: 14px; font-weight: bold;">
                        æ±å²¸ç¸½æ•¸ï¼š0 | è¥¿å²¸ç¸½æ•¸ï¼š0 | ç¸½æ•¸ï¼š0
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', gridHtml);

            // Automatically set the default voice mode when adding a new grid
            setVoiceMode('è«‹æ‰“è…³åŒ…');
        }

        function addExtraCell() {
            const container = document.getElementById('extraCellsContainer');
            const cellId = `cell-${cellCounter++}`;
            const cellHtml = `
                <div class="extra-cell" id="${cellId}">
                    <div class="grid-cell" onclick="applyNoting(this)"></div>
                    <button class="delete-btn" onclick="deleteExtraCell('${cellId}')">ğŸ—‘ï¸ åˆªé™¤æ ¼å­</button>
                    <div class="race-info" style="margin-top: 5px; font-size: 14px; color: gray;">
                        å ´æ¬¡ï¼šç„¡
                    </div>
                    <div class="grid-summary" style="margin-top: 5px; font-size: 14px; font-weight: bold;">
                        æ±å²¸ç¸½æ•¸ï¼š0 | è¥¿å²¸ç¸½æ•¸ï¼š0 | ç¸½æ•¸ï¼š0
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cellHtml);
        }

        function updateSpeechRate(value) {
            speechRate = parseFloat(value);
            document.getElementById('rateValue').textContent = value + 'x';
        }

        function goToPage4() {
            goToPage(4);

            const page3Content = document.getElementById('raceSettings').cloneNode(true);
            const container = document.getElementById('confirmationSettings');
            container.innerHTML = '';
            container.appendChild(page3Content);

            const cells = container.querySelectorAll('.number-cell');
            cells.forEach(cell => {
                cell.onclick = () => {
                    const targetGrid = findAvailableGridCell();
                    if (targetGrid) {
                        moveToGrid(cell, targetGrid);
                    }
                };

                // ä¿ç•™åŸä¾†çš„èƒŒæ™¯é¡è‰²ï¼ˆç¢ºä¿é©—å°¿æ¨¡å¼æ¨™è¨˜ä¹Ÿè¤‡è£½éä¾†ï¼‰
                if (cell.classList.contains('purple-bg')) {
                    cell.classList.add('purple-bg');
                } else if (cell.dataset.mode) {
                    switch (cell.dataset.mode) {
                        case 'yellow':
                            cell.classList.add('yellow-bg');
                            break;
                        case 'green':
                            cell.classList.add('green-bg');
                            break;
                        case 'car':
                            if (!cell.querySelector('.car-icon')) {
                                cell.innerHTML += '<span class="car-icon">ğŸš—</span>';
                            }
                            break;
                    }
                }
            });
        }

        function toggleNotingMode() {
            notingMode = !notingMode;

            // æ”¹è®ŠæŒ‰éˆ•çš„èƒŒæ™¯é¡è‰²ï¼Œè¡¨ç¤ºæ¨¡å¼é–‹å•Ÿ/é—œé–‰
            document.querySelectorAll('.noting-btn').forEach(btn => {
                btn.style.backgroundColor = notingMode ? 'darkred' : 'red';
                btn.style.color = 'white';
            });
        }

        function applyNoting(cell) {
            if (!notingMode) return;  // åªæœ‰åœ¨ noting æ¨¡å¼é–‹å•Ÿæ™‚æ‰å…è¨±æ“ä½œ

            if (cell.textContent === "noting") {
                cell.textContent = "";  // å†æ¬¡é»æ“Šæ¸…é™¤ noting
                cell.classList.remove("red-bg");  // ä¹Ÿç§»é™¤ç´…è‰²èƒŒæ™¯
            } else if (!cell.textContent.trim()) { // åªæœ‰ç©ºç™½æ ¼å­æ‰èƒ½è¨­ç½® noting
                cell.textContent = "noting";
                cell.classList.add("red-bg"); // ç´…è‰²èƒŒæ™¯æ¨™è¨˜ noting
            }
        }

        function setVoiceMode(mode) {
            voiceMode = mode;

            // å…ˆç§»é™¤æ‰€æœ‰èªéŸ³æ¨¡å¼æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.voice-mode-button').forEach(btn => btn.classList.remove('selected-button'));

            // éæ­·æ‰€æœ‰èªéŸ³æ¨¡å¼æŒ‰éˆ•ï¼Œä¸¦è¨­å®šç›®å‰é¸ä¸­çš„æ¨¡å¼
            document.querySelectorAll(`button[data-mode="${mode}"]`).forEach(btn => btn.classList.add('selected-button'));
        }

        // Add this to initialize the default voice mode when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            setVoiceMode('è«‹æ‰“è…³åŒ…');
        });
    </script>
</body>
</html>